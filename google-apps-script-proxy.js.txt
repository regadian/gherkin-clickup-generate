// 1. Go to script.google.com and create a new project.
// 2. Name your project (e.g., "ClickUp Proxy").
// 3. Delete any placeholder code and paste this entire script.
// 4. Click "Deploy" > "New deployment".
// 5. Click the gear icon next to "Select type" and choose "Web app".
// 6. Configure the deployment:
//    - Description: ClickUp API Proxy
//    - Execute as: Me (your@email.com)
//    - Who has access: Anyone  <-- IMPORTANT
// 7. Click "Deploy".
// 8. Authorize the script when prompted.
// 9. Copy the "Web app URL". You will paste this URL into the main application.

function doPost(e) {
  try {
    // Parse the incoming request body from the React app
    const requestData = JSON.parse(e.postData.contents);
    const { token, listId, testCase } = requestData;

    if (!token || !listId || !testCase) {
      throw new Error("Missing token, listId, or testCase data in the request.");
    }
    
    // CRITICAL FIX: Replace literal "\\n" with actual newline characters for ClickUp's markdown rendering.
    // Using a double newline ensures each Gherkin step is on its own line.
    const formattedDescription = testCase.description.replace(/\\n/g, '\n\n');

    // Build the payload for the ClickUp API
    const payload = {
      name: testCase.name,
      description: formattedDescription,
      priority: testCase.priority,
    };
    
    // Add tags to the payload if they exist in the request
    if (testCase.tags && Array.isArray(testCase.tags) && testCase.tags.length > 0) {
      payload.tags = testCase.tags;
    }

    // --- NEW: Handle Custom Fields ---
    if (testCase.custom_fields && Array.isArray(testCase.custom_fields) && testCase.custom_fields.length > 0) {
      const fieldsApiUrl = `https://api.clickup.com/api/v2/list/${listId}/field`;
      const fieldsOptions = {
        method: 'get',
        contentType: 'application/json',
        headers: { 'Authorization': token },
        muteHttpExceptions: true
      };
      
      const fieldsResponse = UrlFetchApp.fetch(fieldsApiUrl, fieldsOptions);
      const fieldsResponseBody = fieldsResponse.getContentText();
      const fieldsResponseCode = fieldsResponse.getResponseCode();

      if (fieldsResponseCode !== 200) {
        throw new Error(`Could not fetch custom fields for list ${listId}. Status: ${fieldsResponseCode}. Response: ${fieldsResponseBody}`);
      }
      
      const availableFields = JSON.parse(fieldsResponseBody).fields;
      const finalCustomFields = [];

      for (const incomingField of testCase.custom_fields) {
        // Guard against malformed incoming field data from client
        if (!incomingField || !incomingField.name || !incomingField.value) continue;

        // Find the definition for the custom field from the list's available fields (robustly)
        const fieldDefinition = availableFields.find(
          f => f && f.name && f.name.toLowerCase() === incomingField.name.toLowerCase()
        );
        
        // If the field is found and is a dropdown or label type
        if (fieldDefinition && (fieldDefinition.type === "drop_down" || fieldDefinition.type === "labels")) {
          // Ensure there is a type_config and options array to search (robustly)
          const options = (fieldDefinition.type_config && Array.isArray(fieldDefinition.type_config.options)) 
            ? fieldDefinition.type_config.options 
            : [];

          // Find the specific option that matches the incoming value (robustly)
          const option = options.find(
            o => o && o.name && o.name.toLowerCase() === incomingField.value.toLowerCase()
          );

          if (option) {
            finalCustomFields.push({ id: fieldDefinition.id, value: option.id });
          }
        }
      }
      
      if (finalCustomFields.length > 0) {
        payload.custom_fields = finalCustomFields;
      }
    }
    // --- END: Handle Custom Fields ---


    const clickUpApiUrl = `https://api.clickup.com/api/v2/list/${listId}/task`;

    const options = {
      method: 'post',
      contentType: 'application/json',
      headers: {
        'Authorization': token
      },
      payload: JSON.stringify(payload),
      muteHttpExceptions: true // Important to catch errors manually
    };

    // Make the server-side call to ClickUp
    const response = UrlFetchApp.fetch(clickUpApiUrl, options);
    const responseCode = response.getResponseCode();
    const responseBody = response.getContentText();

    if (responseCode >= 200 && responseCode < 300) {
      const data = JSON.parse(responseBody);
      return createJsonResponse({
        success: true,
        message: 'Task created successfully.',
        clickUpId: data.id
      });
    } else {
      const errorData = JSON.parse(responseBody);
      throw new Error(`ClickUp API Error: ${errorData.err} (Status: ${responseCode})`);
    }

  } catch (error) {
    // Return a structured error message to the client
    return createJsonResponse({
      success: false,
      message: error.message
    });
  }
}

// Helper function to create a proper JSON response for Apps Script
function createJsonResponse(data) {
  return ContentService
    .createTextOutput(JSON.stringify(data))
    .setMimeType(ContentService.MimeType.JSON);
}